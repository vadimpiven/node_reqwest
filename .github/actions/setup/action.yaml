name: "Setup Environment"
description: "Platform-aware setup - uses Docker on Linux, native on others"
inputs:
  env:
    description: "Environment variables in JSON format"
    required: true
  cache-key:
    description: "Cache key prefix"
    required: true
  docker-image:
    description: "Docker image tag to use"
    required: true
  docker-cache:
    description: "Docker cache registry reference"
    required: true
  github-token:
    description: "GitHub token for authenticated API requests"
    required: true
  docker-service:
    description: "Docker service name"
    required: true
runs:
  using: "composite"
  steps:
    - name: "Extend environment with cache paths"
      id: "native-env"
      shell: "bash"
      env:
        INPUT_ENV: "${{ inputs.env }}"
      run: |
        RESULT=$(echo "$INPUT_ENV" | jq -c --arg workspace "$GITHUB_WORKSPACE" '
          . + {
            "UV_CACHE_DIR": ($workspace + "/.cache/native/uv"),
            "npm_config_store_dir": ($workspace + "/.cache/native/pnpm-store"),
            "CARGO_HOME": ($workspace + "/.cache/native/cargo"),
            "SCCACHE_DIR": ($workspace + "/.cache/native/sccache")
          }
        ')
        echo "env=$RESULT" >> "$GITHUB_OUTPUT"
    - name: "Restore cargo cache"
      uses: "actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb" # v5.0.1
      with:
        path: "${{ runner.os == 'Linux' && '.cache/docker/cargo' || '.cache/native/cargo' }}"
        key: "${{ inputs.cache-key }}-cargo-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('Cargo.lock') }}"
        restore-keys: |
          ${{ inputs.cache-key }}-cargo-${{ runner.os }}-${{ runner.arch }}-
    - name: "Write GITHUB_TOKEN to .env"
      shell: "bash"
      env:
        GITHUB_TOKEN: "${{ inputs.github-token }}"
      run: |
        printf "GITHUB_TOKEN=%s\n" "$GITHUB_TOKEN" >> .env
    - name: "Setup (Docker)"
      if: "runner.os == 'Linux'"
      uses: "./.github/actions/setup-docker"
      with:
        env: "${{ inputs.env }}"
        cache-key: "${{ inputs.cache-key }}"
        docker-image: "${{ inputs.docker-image }}"
        docker-cache: "${{ inputs.docker-cache }}"
        github-token: "${{ inputs.github-token }}"
        docker-service: "${{ inputs.docker-service }}"
    - name: "Setup (Native)"
      if: "runner.os != 'Linux'"
      uses: "./.github/actions/setup-native"
      with:
        env: "${{ steps.native-env.outputs.env }}"
        cache-key: "${{ inputs.cache-key }}"
        github-token: "${{ inputs.github-token }}"
