services:
  dev:
    # Proxy configuration - all traffic goes through mitmproxy
    environment:
      MITM_PROXY: 1
      HTTP_PROXY: http://mitmweb:8080
      HTTPS_PROXY: http://mitmweb:8080
      http_proxy: http://mitmweb:8080
      https_proxy: http://mitmweb:8080
      NO_PROXY: localhost,127.0.0.1,::1
      no_proxy: localhost,127.0.0.1,::1
      # For @electron/get (uses global-agent internally)
      ELECTRON_GET_USE_PROXY: 1
      GLOBAL_AGENT_HTTP_PROXY: http://mitmweb:8080
      GLOBAL_AGENT_HTTPS_PROXY: http://mitmweb:8080
      GLOBAL_AGENT_NO_PROXY: localhost,127.0.0.1,::1
      # For Python tools (semgrep)
      REQUESTS_CA_BUNDLE: /etc/pki/tls/certs/ca-bundle.crt
      # For Node.js tools (VS Code)
      # Standard SSL variables for Rust/OpenSSL/Mise/curl
      SSL_CERT_FILE: /etc/ssl/certs/ca-certificates.crt
      SSL_CERT_DIR: /etc/pki/tls/certs
      CARGO_HTTP_CAINFO: /etc/ssl/certs/ca-certificates.crt
      CURL_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      # NPM configuration
      NODE_EXTRA_CA_CERTS: /etc/ssl/certs/ca-certificates.crt
      NPM_CONFIG_CAFILE: /etc/ssl/certs/ca-certificates.crt
      pnpm_config_cafile: /etc/ssl/certs/ca-certificates.crt
    volumes:
      # Mitmproxy CA certificate volume (read-only)
      - mitmproxy-certs:/mitmproxy-certs:ro
    networks:
      - internal_net
    depends_on:
      mitmweb:
        condition: service_healthy
  mitmweb:
    # <https://hub.docker.com/layers/mitmproxy/mitmproxy/latest/images/>
    image: mitmproxy/mitmproxy@sha256:743b6cdc817211d64bc269f5defacca8d14e76e647fc474e5c7244dbcb645141
    # http://127.0.0.1:8081/?token=mitmproxy
    command: >
      mitmweb
      --listen-host 0.0.0.0
      --listen-port 8080
      --web-host 0.0.0.0
      --web-port 8081
      --set web_open_browser=false
      --set block_global=false
      --set web_password=${MITMPROXY_WEB_PASSWORD:-}
      --scripts /scripts/proxy_addon.py
    # Expose mitmweb UI for local debugging - access at http://localhost:8081
    ports:
      - "8081:8081"
    volumes:
      - mitmproxy-certs:/home/mitmproxy/.mitmproxy
      - ./packages/node/tests/mitmproxy:/scripts:ro
    networks:
      - internal_net
      - external_net
    healthcheck:
      test:
        - CMD
        - python3
        - -c
        - |
          import socket
          s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
          s.settimeout(2)
          s.connect(('127.0.0.1', 8081))
      interval: 10s
      timeout: 5s
      start_period: 10s
      retries: 5
networks:
  # No internet access - dev can ONLY reach mitmweb
  internal_net:
    driver: bridge
    internal: true
  # Normal network with internet access for mitmweb
  external_net:
    driver: bridge
volumes:
  # Named volume to share mitmproxy CA certificates between containers
  mitmproxy-certs:
