# mise.toml - Single source of truth for all tool versions
# https://mise.jdx.dev/

redactions = ["*_TOKEN", "*_SECRET", "*_KEY", "*_PASSWORD"]

[settings]
experimental = true
env_file = ".env"
npm.package_manager = "pnpm"
rust.cargo_home = ".cache/native/cargo"
rust.rustup_home = ".cache/native/rustup"

[env]
PYTHONUTF8 = "1"
PYTHONWARNINGS = "ignore"
SCCACHE_CACHE_SIZE = "1G"

# Cache directories
CARGO_HOME = "{{ config_root }}/.cache/native/cargo"
npm_config_store_dir = "{{ config_root }}/.cache/native/pnpm"
RUSTUP_HOME = "{{ config_root }}/.cache/native/rustup"
SCCACHE_DIR = "{{ config_root }}/.cache/native/sccache"
UV_CACHE_DIR = "{{ config_root }}/.cache/native/uv"
UV_PROJECT_ENVIRONMENT = "{{ config_root }}/.cache/native/venv"

# Add Rust binaries to PATH
_.path = ["{{ config_root }}/.cache/native/cargo/bin"]

# Set Python virtual environment path
_.python.venv.path = "{{ config_root }}/.cache/native/venv"

[tools]
# Node
pnpm = "10.28.0"
node = "22.21.1"

# Rust
rust.version = "nightly-2026-01-10"
rust.profile = "minimal"
rust.components = "clippy,rustfmt,llvm-tools-preview"

# Rust tools
"github:cargo-bins/cargo-binstall" = "1.16.6"
"github:nextest-rs/nextest" = "cargo-nextest-0.9.117"
"github:EmbarkStudios/cargo-deny" = "0.19.0"
"github:mstange/samply" = "samply-v0.13.1"
"github:crate-ci/typos" = "v1.42.0"
"github:taiki-e/cargo-llvm-cov" = "0.6.23"

# Common tools
"github:aquasecurity/trivy" = "0.68.2"
"github:google/yamlfmt" = "0.21.0"
"github:koalaman/shellcheck" = "0.10.0"
"github:astral-sh/uv" = "0.9.24"
# hadolint - no Windows ARM64 binary available
[tools."github:hadolint/hadolint"]
version = "2.14.0"
[tools."github:hadolint/hadolint".platforms]
windows-x64 = true
linux-x64 = true
linux-arm64 = true
macos-x64 = true
macos-arm64 = true
# windows-arm64 intentionally omitted - no binary available

# sccache - need explicit asset_pattern to avoid picking sccache-dist
[tools."github:mozilla/sccache"]
version = "0.13.0"
filter_bins = "sccache"

[tools."github:mozilla/sccache".platforms]
linux-x64 = { asset_pattern = "sccache-v*-x86_64-unknown-linux-musl.tar.gz" }
linux-arm64 = { asset_pattern = "sccache-v*-aarch64-unknown-linux-musl.tar.gz" }
macos-x64 = { version = "0.12.0" }

# Biome - uses @biomejs/biome@X.Y.Z tag format with platform-specific binaries
[tools."github:biomejs/biome"]
version_prefix = "@biomejs/biome@"
version = "2.3.11"

[tools."github:biomejs/biome".platforms]
windows-x64 = { asset_pattern = "biome-win32-x64.exe", bin = "biome.exe" }
windows-arm64 = { asset_pattern = "biome-win32-arm64.exe", bin = "biome.exe" }
linux-x64 = { asset_pattern = "biome-linux-x64-musl", bin = "biome" }
linux-arm64 = { asset_pattern = "biome-linux-arm64-musl", bin = "biome" }
macos-x64 = { asset_pattern = "biome-darwin-x64", bin = "biome" }
macos-arm64 = { asset_pattern = "biome-darwin-arm64", bin = "biome" }

# Hooks - auto-run after mise install
[hooks]
postinstall = "node scripts/postinstall.ts"

# ============================================================================
# LINT & CHECK TASKS - Verify code quality and security
# ============================================================================

[tasks."check:ruff"]
description = "Check Python code with ruff"
run = "uv run --no-sync ruff check --diff && uv run --no-sync ruff format --check --diff"
sources = ["packages/**/*.py", "pyproject.toml"]

[tasks."check:pyrefly"]
description = "Check Python code with pyrefly"
run = "uv run --no-sync pyrefly check"
sources = ["packages/**/*.py", "pyproject.toml"]

[tasks."check:biome"]
description = "Check JS/TS/JSON with Biome"
run = "biome check . --log-level warn"
sources = [
    "*.json",
    "scripts/**/*.ts",
    "packages/**/*.{ts,js,mts,mjs,json,jsonc}",
    ".vscode/*.json",
    "biome.json",
]

[tasks."check:taplo"]
description = "Check TOML files with taplo"
run = "pnpm exec taplo check"
sources = ["*.toml", "{.cargo,.config,packages}/**/*.toml"]

[tasks."check:markdownlint"]
description = "Check Markdown files"
run = "pnpm exec markdownlint-cli2"
sources = ["*.md", "packages/**/*.md", "plans/*.md", ".markdownlint-cli2.jsonc"]

[tasks."check:yamlfmt"]
description = "Check YAML formatting"
run = "yamlfmt -gitignore_excludes -lint"
sources = ["*.{yaml,yml}", ".github/**/*.{yaml,yml}", ".devcontainer/*.yaml"]

[tasks."check:clippy"]
description = "Check Rust code with clippy"
run = "cargo clippy -r --locked -- -D warnings"
sources = ["packages/**/*.rs", "Cargo.{toml,lock}", "clippy.toml"]

[tasks."check:rustfmt"]
description = "Check Rust formatting"
run = "cargo fmt --check"
sources = ["packages/**/*.rs", "rustfmt.toml"]

[tasks."check:cargo-deny"]
description = "Check Rust dependencies with cargo-deny"
run = "cargo deny check"
sources = ["Cargo.{toml,lock}", "deny.toml"]

[tasks."check:typos"]
description = "Check for typos in all files"
run = "typos ."
sources = [
    "*.{md,toml,json,yaml,yml}",
    "scripts/**/*.ts",
    "packages/**/*.{md,rs,ts,js,py,toml,json}",
    "plans/*.md",
    ".github/**/*.{yaml,yml}",
]

[tasks."check:shellcheck"]
description = "Check shell scripts with shellcheck"
run = "shellcheck docker-entrypoint.sh"
sources = ["docker-entrypoint.sh"]

[tasks."check:hadolint"]
description = "Check Dockerfile with hadolint"
run = "hadolint Dockerfile"
run_windows = "exit 0"
sources = ["Dockerfile", ".hadolint.yaml"]

[tasks."check:zizmor"]
description = "Security audit GitHub Actions with zizmor"
run = "uv run --no-sync zizmor -q --persona auditor .github"
sources = [".github/**/*.{yaml,yml}"]

[tasks."check:semgrep"]
description = "Security scan with semgrep"
run = "uv run --no-sync semgrep scan --error -q"
sources = ["packages/**/*.{py,rs,ts,js}", ".github/**/*.{yaml,yml}"]

[tasks."check:trivy"]
description = "Security scan with trivy"
run = "trivy fs . --format table"
sources = ["*.{toml,lock,json}", "packages/**/*.{toml,json}", "trivy.yaml", "Dockerfile"]

[tasks.check]
description = "Run all checks"
depends = [
    "check:ruff",
    "check:pyrefly",
    "check:biome",
    "check:taplo",
    "check:markdownlint",
    "check:yamlfmt",
    "check:clippy",
    "check:rustfmt",
    "check:cargo-deny",
    "check:typos",
    "check:shellcheck",
    "check:hadolint",
    "check:zizmor",
    "check:semgrep",
    "check:trivy",
]

# ============================================================================
# FIX TASKS - Auto-fix issues where possible
# ============================================================================

[tasks."fix:ruff"]
description = "Fix Python code with ruff"
run = "uv run --no-sync ruff check --fix && uv run --no-sync ruff format"
sources = ["packages/**/*.py", "pyproject.toml"]

[tasks."fix:pyrefly"]
description = "Fix pyrefly issues"
run = "uv run --no-sync pyrefly check --remove-unused-ignores --all"
sources = ["packages/**/*.py", "pyproject.toml"]

[tasks."fix:biome"]
description = "Fix JS/TS/JSON with Biome"
run = "biome check . --log-level warn --fix"
sources = [
    "*.json",
    "scripts/**/*.ts",
    "packages/**/*.{ts,js,mts,mjs,json,jsonc}",
    ".vscode/*.json",
    "biome.json",
]

[tasks."fix:taplo"]
description = "Format TOML files with taplo"
run = "pnpm exec taplo format"
sources = ["*.toml", "{.cargo,.config,packages}/**/*.toml"]

[tasks."fix:markdownlint"]
description = "Fix Markdown files"
run = "pnpm exec markdownlint-cli2 --fix"
sources = ["*.md", "packages/**/*.md", "plans/*.md", ".markdownlint-cli2.jsonc"]

[tasks."fix:yamlfmt"]
description = "Format YAML files"
run = "yamlfmt -gitignore_excludes"
sources = ["*.{yaml,yml}", ".github/**/*.{yaml,yml}", ".devcontainer/*.yaml"]

[tasks."fix:clippy"]
description = "Fix Rust code with clippy"
run = "cargo clippy --fix --allow-dirty"
sources = ["packages/**/*.rs", "Cargo.{toml,lock}", "clippy.toml"]

[tasks."fix:rustfmt"]
description = "Format Rust code"
depends = ["fix:clippy"]
run = "cargo fmt"
sources = ["packages/**/*.rs", "rustfmt.toml"]

[tasks."fix:cargo-deny"]
description = "Check cargo-deny (no auto-fix available)"
run = "cargo deny check"
sources = ["Cargo.{toml,lock}", "deny.toml"]

[tasks."fix:typos"]
description = "Fix typos in all files"
run = "typos -w ."
sources = [
    "*.{md,toml,json,yaml,yml}",
    "scripts/**/*.ts",
    "packages/**/*.{md,rs,ts,js,py,toml,json}",
    "plans/*.md",
    ".github/**/*.{yaml,yml}",
]

[tasks."fix:shellcheck"]
description = "Check shell scripts (no auto-fix available)"
run = "shellcheck docker-entrypoint.sh"
sources = ["docker-entrypoint.sh"]

[tasks."fix:hadolint"]
description = "Check Dockerfile (no auto-fix available)"
run = "hadolint Dockerfile"
run_windows = "exit 0"
sources = ["Dockerfile", ".hadolint.yaml"]

[tasks."fix:zizmor"]
description = "Check GitHub Actions (no auto-fix available)"
run = "uv run --no-sync zizmor -q --persona auditor .github"
sources = [".github/**/*.{yaml,yml}"]

[tasks."fix:semgrep"]
description = "Fix semgrep issues"
run = "uv run --no-sync semgrep scan --error -q --autofix"
sources = ["packages/**/*.{py,rs,ts,js}", ".github/**/*.{yaml,yml}"]

[tasks."fix:trivy"]
description = "Check trivy (no auto-fix available)"
run = "trivy fs . --format table"
sources = ["*.{toml,lock,json}", "packages/**/*.{toml,json}", "trivy.yaml", "Dockerfile"]

[tasks.fix]
description = "Run all fixes"
depends = [
    "fix:ruff",
    "fix:pyrefly",
    "fix:biome",
    "fix:taplo",
    "fix:markdownlint",
    "fix:yamlfmt",
    "fix:clippy",
    "fix:rustfmt",
    "fix:cargo-deny",
    "fix:typos",
    "fix:shellcheck",
    "fix:hadolint",
    "fix:zizmor",
    "fix:semgrep",
    "fix:trivy",
]

# ============================================================================
# CLEAN TASKS - Cleanup caches and build artifacts
# ============================================================================

[tasks."clean:pnpm"]
description = "Clean pnpm store"
run = "pnpm store prune"

[tasks."clean:cargo"]
description = "Clean cargo cache and build artifacts"
run = "cargo -Z gc clean gc && cargo clean"

[tasks."clean:rustup"]
description = "Clean unused rustup toolchains"
run = "node scripts/clean-rustup.ts"

[tasks."clean:docker"]
description = "Clean Docker containers and images"
run = "docker compose down --volumes --remove-orphans && docker system prune -af"

[tasks.clean]
description = "Run all cleanup tasks"
depends = ["clean:pnpm", "clean:cargo", "clean:rustup", "clean:docker"]

# ============================================================================
# UPDATE CHECK TASKS - Check for available updates
# ============================================================================

[tasks."check-updates:pnpm"]
description = "Check for pnpm updates"
run = "(pnpm outdated --recursive --sort-by name || exit 0)"

[tasks."check-updates:cargo"]
description = "Check for cargo updates"
run = "cargo update --breaking -Z unstable-options --dry-run"

[tasks."check-updates:uv"]
description = "Check for uv/Python updates"
run = "uv lock --upgrade --dry-run"

[tasks.check-updates]
description = "Check for all updates"
depends = ["check-updates:pnpm", "check-updates:cargo", "check-updates:uv"]

# ============================================================================
# UPDATE TASKS - Apply updates
# ============================================================================

[tasks."update:pnpm"]
description = "Update pnpm dependencies"
run = "pnpm update --recursive --workspace && pnpm audit --fix && pnpm install"

[tasks."update:cargo"]
description = "Update cargo dependencies"
run = "cargo -Z gc clean gc && cargo clean && cargo update"

[tasks."update:uv"]
description = "Update uv/Python dependencies"
run = "uv lock --upgrade"

[tasks.update]
description = "Run all updates"
depends = ["update:pnpm", "update:cargo", "update:uv"]

# ============================================================================
# BUILD & TEST TASKS - Build and test the project
# ============================================================================

[tasks."ci-build"]
description = "Build for CI (runs recursive pnpm ci-build)"
run = "pnpm run --recursive ci-build"
sources = ["packages/**/*.{rs,ts,js}", "Cargo.{toml,lock}"]

[tasks."ci-test"]
description = "Run CI tests with pre-check"
run = "pnpm run --recursive ci-test"
depends = ["check"]
sources = ["packages/**/*.{rs,ts,js}", "Cargo.{toml,lock}"]

[tasks.build]
description = "Build all packages"
run = "pnpm run --recursive build"
sources = ["packages/**/*.{rs,ts,js}", "Cargo.{toml,lock}"]

[tasks.test]
description = "Run all tests with pre-fix"
run = "pnpm run --recursive test"
depends = ["fix"]
sources = ["packages/**/*.{rs,ts,js}", "Cargo.{toml,lock}"]
